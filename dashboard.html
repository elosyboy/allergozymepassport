<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mon espace — AllergoZyme Passport</title>
<link rel="icon" href="logo.png"/>
<style>
:root{
  --black:#0a0a0a; --black2:#0d0d0e; --black3:#131316; --black4:#0b0b0c;
  --ink:#e7e7ea; --mute:#a8a8b6; --gold:#b6952a; --line:#202024;
  --r:22px; --maxw:1100px;
}
*{box-sizing:border-box; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{margin:0; background:var(--black); color:var(--ink); min-height:100vh; display:flex; flex-direction:column}
.gridbg{position:fixed; inset:-20vh -20vw; z-index:0;
  background:
    radial-gradient(800px 400px at 50% -10%, rgba(183,149,40,.08), transparent 60%),
    repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 80px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 80px);
  mask-image: radial-gradient(80% 60% at 50% 40%, black, transparent);
  animation:drift 60s linear infinite;
}
.noise{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.28; mix-blend-mode:soft-light;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .05 .12 .05 0 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
}
@keyframes drift{to{transform:translate3d(-30px,-20px,0)}}

/* Header */
header{
  position:sticky; top:0; z-index:40; backdrop-filter:blur(10px);
  background:rgba(10,10,10,.6); border-bottom:1px solid var(--line);
}
.head{max-width:var(--maxw); margin:0 auto; padding:14px 22px; display:flex; align-items:center; justify-content:space-between}
.brand{display:flex; align-items:center; gap:12px}
.brand img{width:46px; height:46px; border-radius:12px; object-fit:contain; box-shadow:0 10px 26px rgba(182,149,42,.18)}
.brand h1{margin:0; font-size:1.05rem; letter-spacing:.12em; font-weight:900; text-transform:uppercase; color:#fff}
.h-actions{display:flex; gap:10px; flex-wrap:wrap}
.btn{display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,var(--black2),var(--black3)); color:#fff; cursor:pointer}
.btn:hover{box-shadow:0 10px 28px rgba(182,149,42,.25)}

/* Main */
main{flex:1; width:100%}
.wrap{max-width:var(--maxw); margin:0 auto; padding:28px 22px; position:relative; z-index:1}

/* Cards & sections */
.section{background:linear-gradient(180deg,var(--black2),var(--black3)); border:1px solid var(--line); border-radius:var(--r); padding:26px; margin-bottom:24px}
.section h2{margin:0 0 8px; font-size:1.22rem}
.section p{color:var(--mute); margin:4px 0 16px}

/* Tables */
.table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line)}
.table th,.table td{padding:12px 12px; border-bottom:1px solid var(--line); font-size:.95rem}
.table th{background:#0f0f12; color:#fff; text-align:left; letter-spacing:.02em}
.table td{color:#d9d9e2}

/* Code box */
.codebox{border:1px solid var(--line); border-radius:16px; padding:18px; text-align:center; background:linear-gradient(180deg,#0f0f12,#0b0b0c)}
.codebox strong{display:block; color:#fff}
.code{font-size:1.6rem; font-weight:900; color:var(--gold); text-shadow:0 0 12px rgba(182,149,42,.4)}
.code-note{font-size:.86rem; color:var(--mute)}

/* Footer */
footer{border-top:1px solid var(--line); margin-top:20px; background:var(--black4)}
.foot{max-width:var(--maxw); margin:0 auto; padding:20px 22px; color:var(--mute); text-align:center}

/* Modal (déclaration & ajout visite) */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:60; backdrop-filter:blur(3px)}
.modal{width:min(640px,92vw); background:linear-gradient(180deg,var(--black2),var(--black3)); border:1px solid var(--line); border-radius:18px; padding:20px}
.modal h3{margin:0 0 10px}
.modal .row{display:grid; gap:8px; margin-bottom:12px}
.modal input, .modal textarea{
  width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
  background:#0b0b0c; color:#fff; resize:vertical
}
.modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
.badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#151517,#0f0f12); color:#fff; font-size:.88rem}
.note{color:var(--mute); font-size:.9rem}
.error{color:#ff8f8f}
.success{color:#8fffac}

@media (max-width:840px){
  .h-actions{gap:8px}
}
</style>
</head>
<body>
<div class="gridbg" aria-hidden="true"></div>
<div class="noise" aria-hidden="true"></div>

<header>
  <div class="head">
    <div class="brand">
      <img src="logo.png" alt="logo"/>
      <h1>AllergoZyme Passport</h1>
    </div>
    <div class="h-actions">
      <button class="btn" id="sellTipsBtn">Script de vente</button>
      <button class="btn" id="logoutBtn">Déconnexion</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- Passeport santé -->
    <section class="section">
      <div class="badge">Mon passeport santé</div>
      <h2>Ma page Allergie</h2>
      <p>Centralisez vos allergies, intolérances et besoins diabétiques. Accès uniquement sur votre accord, pour créer une preuve lisible et opposable.</p>
      <button class="btn" id="editAllergies">Remplir / Modifier ma page allergie</button>
    </section>

    <!-- Etablissements recommandés -->
    <section class="section">
      <div class="badge">Gains</div>
      <h2>Mes établissements recommandés</h2>
      <p>Chaque établissement inscrit via votre code personnel génère 10 € dès validation (J+14 après adhésion).</p>
      <table class="table">
        <thead><tr><th>Nom</th><th>Date</th><th>Statut</th><th>Gain</th></tr></thead>
        <tbody id="tbody-reco">
          <tr><td colspan="4" style="text-align:center; color:var(--mute)">Chargement…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Restaurants fréquentés (depuis signatures + join restaurants) -->
    <section class="section">
      <div class="badge">Preuve côté client</div>
      <h2>Mes restaurants fréquentés</h2>
      <p class="note">Ce journal est rempli automatiquement par vos signatures. Vous pouvez aussi ajouter une visite manuelle si besoin.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px">
        <button class="btn" id="btnAddVisit">Ajouter une visite</button>
        <span id="visitsHint" class="note"></span>
      </div>
      <table class="table">
        <thead><tr><th>Établissement</th><th>Adresse</th><th>Date</th><th></th></tr></thead>
        <tbody id="tbody-visits">
          <tr><td colspan="4" style="text-align:center; color:var(--mute)">Chargement…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Code personnel -->
    <section class="section">
      <div class="badge">Parrainage</div>
      <h2>Mon code personnel</h2>
      <div class="codebox">
        <strong>AllergoZyme Passport — Code</strong>
        <div id="userCode" class="code">Chargement…</div>
        <div class="code-note">À communiquer au restaurateur lors de son inscription afin de tracer votre recommandation.</div>
      </div>
    </section>

    <!-- Carte label -->
    <section class="section">
      <div class="badge">Label</div>
      <h2>Carte des établissements labellisés</h2>
      <p>Consultez la carte officielle : <a href="https://www.allergozymelabel.com" target="_blank" style="color:#fff; text-decoration:underline">allergozymelabel.com</a></p>
    </section>

  </div>
</main>

<footer>
  <div class="foot">© <span id="year"></span> AllergoZyme Passport — Données protégées et confidentielles</div>
</footer>

<!-- Modal : voir déclaration -->
<div class="backdrop" id="modalDecl">
  <div class="modal">
    <h3 id="declTitle">Déclaration</h3>
    <div id="declBody" class="note" style="white-space:pre-line"></div>
    <div class="actions">
      <button class="btn" id="declDownload">Télécharger en PDF</button>
      <button class="btn" id="declClose">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal : ajouter visite manuelle -->
<div class="backdrop" id="modalVisit">
  <div class="modal">
    <h3>Ajouter une visite</h3>
    <div class="row">
      <label for="visitName">Établissement</label>
      <input id="visitName" placeholder="Nom du restaurant" />
    </div>
    <div class="row">
      <label for="visitAddr">Adresse (optionnelle)</label>
      <textarea id="visitAddr" rows="2" placeholder="Adresse complète (si souhaité)"></textarea>
    </div>
    <div class="note">La visite sera insérée dans <code>restaurants</code> avec <code>client_email = votre email</code>.</div>
    <div id="visitMsg" class="note" style="margin-top:8px"></div>
    <div class="actions">
      <button class="btn" id="visitSave">Enregistrer</button>
      <button class="btn" id="visitCancel">Annuler</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://tmrraeutjrcsozijjbzm.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcnJhZXV0anJjc296aWpqYnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA4NzIsImV4cCI6MjA3NjM3Njg3Mn0.015qUFsUyndsesz5RHGKWO1Ipoz7C3vcVZulACGmq0g'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// DOM
const year = document.getElementById('year'); year.textContent = new Date().getFullYear()
const tbodyReco = document.getElementById('tbody-reco')
const tbodyVisits = document.getElementById('tbody-visits')
const userCodeEl = document.getElementById('userCode')
const visitsHint = document.getElementById('visitsHint')

// header actions
document.getElementById('logoutBtn').onclick = async () => { await sb.auth.signOut(); window.location.href='identification.html' }
document.getElementById('sellTipsBtn').onclick = () => { window.location.href='vendre.html' }
document.getElementById('editAllergies').onclick = () => { window.location.href='remplir-allergies.html' }

// modals
const modalVisit = document.getElementById('modalVisit')
const visitSave = document.getElementById('visitSave')
const visitCancel = document.getElementById('visitCancel')
const visitMsg = document.getElementById('visitMsg')
const visitName = document.getElementById('visitName')
const visitAddr = document.getElementById('visitAddr')
document.getElementById('btnAddVisit').onclick = () => { visitName.value=''; visitAddr.value=''; visitMsg.textContent=''; modalVisit.style.display='flex' }
visitCancel.onclick = () => { modalVisit.style.display='none' }

const modalDecl = document.getElementById('modalDecl')
const declTitle = document.getElementById('declTitle')
const declBody = document.getElementById('declBody')
const declClose = document.getElementById('declClose')
const declDownload = document.getElementById('declDownload')
declClose.onclick = () => { modalDecl.style.display='none' }

// auth gate
const { data: { user } } = await sb.auth.getUser()
if(!user){ window.location.href='identification.html' }

// fetch vendeur (code promo)
let codePromo = null
try{
  const { data: vendeur, error: errV } = await sb.from('vendeurs').select('code_promo').eq('email', user.email).single()
  if (errV) throw errV
  codePromo = vendeur?.code_promo || null
  userCodeEl.textContent = codePromo || 'Code non attribué'
}catch(e){
  userCodeEl.textContent = 'Code non attribué'
}

// RECOMMANDATIONS
async function loadRecommandes(){
  try{
    if(!codePromo){
      tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucun code personnel trouvé.</td></tr>'
      return
    }
    const { data: etabs, error } = await sb
      .from('restaurants')
      .select('etablissement, created_at, paiement')
      .eq('code_parrain', codePromo)
      .order('created_at', { ascending:false })
    if(error) throw error
    if(!etabs || etabs.length===0){
      tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucun établissement pour le moment.</td></tr>'
      return
    }
    tbodyReco.innerHTML = etabs.map(e => `
      <tr>
        <td>${e.etablissement ?? '—'}</td>
        <td>${e.created_at ? new Date(e.created_at).toLocaleDateString('fr-FR') : '—'}</td>
        <td>${e.paiement ? 'Validé' : 'En attente'}</td>
        <td>${e.paiement ? '10 €' : '—'}</td>
      </tr>
    `).join('')
  }catch(e){
    tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ff8f8f">Erreur de chargement.</td></tr>'
  }
}

// VISITES (depuis signatures + join restaurants)
let lastSignaturesCache = [] // pour le modal
async function loadVisites(){
  try{
    // 1. on récupère toutes les signatures de ce client
    const { data: sigs, error: e1 } = await sb
      .from('signatures')
      .select('id, restaurant_id, created_at, allergenes, autres_allergenes, diabete, aucune_allergie, table_ref, consentement, nom_client, emailnumero_client')
      .eq('emailnumero_client', user.email)
      .order('created_at', { ascending:false })
    if(e1) throw e1

    lastSignaturesCache = sigs || []

    if(!sigs || sigs.length === 0){
      tbodyVisits.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucune visite enregistrée pour le moment.</td></tr>'
      visitsHint.innerHTML = "Les visites se remplissent automatiquement quand vous signez dans un restaurant via QR code."
      return
    }

    // 2. on charge les restaurants correspondants
    const ids = [...new Set(sigs.map(s => s.restaurant_id).filter(Boolean))]
    let restMap = {}
    if(ids.length){
      const { data: restos, error: e2 } = await sb
        .from('restaurants')
        .select('id, etablissement, adresse, codepostal, ville')
        .in('id', ids)
      if(e2) throw e2
      restMap = (restos || []).reduce((acc,r)=>{ acc[r.id] = r; return acc }, {})
    }

    // 3. rendu tableau visites
    tbodyVisits.innerHTML = sigs.map(s => {
      const r = restMap[s.restaurant_id] || {}
      const nom = r.etablissement || '—'
      const adr = [r.adresse, r.codepostal, r.ville].filter(Boolean).join(', ') || '—'
      const d   = s.created_at ? new Date(s.created_at).toLocaleString('fr-FR') : '—'
      return `
        <tr>
          <td>${nom}</td>
          <td>${adr}</td>
          <td>${d}</td>
          <td><button class="btn btn-small" data-declid="${s.id}" data-restname="${encodeURIComponent(nom)}">Voir ma déclaration</button></td>
        </tr>
      `
    }).join('')

    // 4. brancher les boutons "Voir ma déclaration"
    document.querySelectorAll('[data-declid]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-declid')
        const restname = decodeURIComponent(btn.getAttribute('data-restname'))
        const decl = lastSignaturesCache.find(x=>x.id===id)
        if(!decl){ return }
        const lignes = []
        lignes.push(`Établissement : ${restname}`)
        lignes.push(`Date : ${decl.created_at ? new Date(decl.created_at).toLocaleString('fr-FR') : '—'}`)
        lignes.push(`Table : ${decl.table_ref || '—'}`)
        lignes.push(`Consentement : ${decl.consentement === false ? 'Non' : 'Oui'}`)
        lignes.push(`Nom déclaré : ${decl.nom_client || '—'}`)
        lignes.push(`Email : ${decl.emailnumero_client || '—'}`)
        lignes.push(`Diabète : ${decl.diabete ? 'Oui' : 'Non'}`)
        lignes.push(`Aucune allergie : ${decl.aucune_allergie ? 'Oui' : 'Non'}`)
        lignes.push(`Allergènes : ${decl.allergenes || (decl.aucune_allergie ? '(Aucun)' : '—')}`)
        lignes.push(`Autres allergènes : ${decl.autres_allergenes || '—'}`)
        declTitle.textContent = 'Déclaration — ' + restname
        declBody.textContent = lignes.join('\n')
        declDownload.onclick = () => downloadDeclPDF(restname, decl)
        modalDecl.style.display = 'flex'
      })
    })

  }catch(e){
    console.error(e)
    tbodyVisits.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ff8f8f">Erreur de chargement.</td></tr>'
  }
}

// Téléchargement “PDF” (impression système)
function downloadDeclPDF(restname, decl){
  const safe = (v)=> (v==null || v==='') ? '—' : String(v)
  const dateStr = decl.created_at ? new Date(decl.created_at).toLocaleString('fr-FR') : '—'
  const html = `
<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"/><title>Déclaration — ${restname}</title>
<style>
  body{font-family:Inter,system-ui; padding:24px; color:#111}
  h1{margin:0 0 12px; font-size:18px}
  .card{border:1px solid #ddd; border-radius:12px; padding:16px}
  .row{margin:6px 0}
  .label{color:#444; font-weight:600}
  @media print {.btn{display:none}}
  .btn{margin-top:12px; padding:10px 16px; border:0; border-radius:999px; background:#111; color:#fff; cursor:pointer}
</style>
</head><body>
  <h1>Déclaration Allergies — ${restname}</h1>
  <div class="card">
    <div class="row"><span class="label">Date :</span> ${dateStr}</div>
    <div class="row"><span class="label">Établissement :</span> ${restname}</div>
    <div class="row"><span class="label">Nom déclaré :</span> ${safe(decl.nom_client)}</div>
    <div class="row"><span class="label">Email :</span> ${safe(decl.emailnumero_client)}</div>
    <div class="row"><span class="label">Table :</span> ${safe(decl.table_ref)}</div>
    <div class="row"><span class="label">Consentement :</span> ${decl.consentement === false ? 'Non' : 'Oui'}</div>
    <div class="row"><span class="label">Diabète :</span> ${decl.diabete ? 'Oui' : 'Non'}</div>
    <div class="row"><span class="label">Aucune allergie :</span> ${decl.aucune_allergie ? 'Oui' : 'Non'}</div>
    <div class="row"><span class="label">Allergènes :</span> ${safe(decl.allergenes)}</div>
    <div class="row"><span class="label">Autres allergènes :</span> ${safe(decl.autres_allergenes)}</div>
  </div>
  <button class="btn" onclick="window.print()">Imprimer / Enregistrer en PDF</button>
</body></html>`
  const w = window.open('', '_blank')
  w.document.open(); w.document.write(html); w.document.close()
}

// Insert visite manuelle (restaurants)
visitSave.onclick = async () => {
  visitMsg.className = 'note'
  try{
    const etab = visitName.value.trim()
    const adr = visitAddr.value.trim()
    if(!etab){ visitMsg.className='note error'; visitMsg.textContent='Veuillez renseigner le nom de l’établissement.'; return }

    const payload = {
      etablissement: etab,
      adresse: adr || null,
      client_email: user.email // si la colonne n’existe pas, une erreur claire sera renvoyée
    }
    const { error } = await sb.from('restaurants').insert([payload])
    if(error){
      visitMsg.className='note error'
      visitMsg.innerHTML = 'Erreur : '+error.message+
        '<br><span class="note">Créez la colonne <code>client_email</code> (TEXT) dans la table <code>restaurants</code> si elle n’existe pas.</span>'
      return
    }

    visitMsg.className='note success'
    visitMsg.textContent = 'Visite enregistrée.'
    await loadVisites()
    setTimeout(()=>{ modalVisit.style.display='none' }, 700)
  }catch(e){
    visitMsg.className='note error'
    visitMsg.textContent = 'Erreur inconnue.'
  }
}

// INIT
await loadRecommandes()
await loadVisites()
</script>
</body>
</html>
