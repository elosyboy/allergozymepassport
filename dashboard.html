<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mon espace — AllergoZyme Passport</title>
<link rel="icon" href="logo.png"/>
<style>
:root{
  --black:#0a0a0a; --black2:#0d0d0e; --black3:#131316; --black4:#0b0b0c;
  --ink:#e7e7ea; --mute:#a8a8b6; --gold:#b6952a; --line:#202024;
  --r:22px; --maxw:1100px;
}
*{box-sizing:border-box; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{margin:0; background:var(--black); color:var(--ink); min-height:100vh; display:flex; flex-direction:column}
.gridbg{position:fixed; inset:-20vh -20vw; z-index:0;
  background:
    radial-gradient(800px 400px at 50% -10%, rgba(183,149,40,.08), transparent 60%),
    repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 80px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 80px);
  mask-image: radial-gradient(80% 60% at 50% 40%, black, transparent);
  animation:drift 60s linear infinite;
}
.noise{position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.28; mix-blend-mode:soft-light;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .05 .12 .05 0 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
}
@keyframes drift{to{transform:translate3d(-30px,-20px,0)}}

/* Header */
header{
  position:sticky; top:0; z-index:40; backdrop-filter:blur(10px);
  background:rgba(10,10,10,.6); border-bottom:1px solid var(--line);
}
.head{max-width:var(--maxw); margin:0 auto; padding:14px 22px; display:flex; align-items:center; justify-content:space-between}
.brand{display:flex; align-items:center; gap:12px}
.brand img{width:46px; height:46px; border-radius:12px; object-fit:contain; box-shadow:0 10px 26px rgba(182,149,42,.18)}
.brand h1{margin:0; font-size:1.05rem; letter-spacing:.12em; font-weight:900; text-transform:uppercase; color:#fff}
.h-actions{display:flex; gap:10px; flex-wrap:wrap}
.btn{display:inline-flex; align-items:center; gap:10px; padding:10px 16px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,var(--black2),var(--black3)); color:#fff; cursor:pointer}
.btn:hover{box-shadow:0 10px 28px rgba(182,149,42,.25)}

/* Main */
main{flex:1; width:100%}
.wrap{max-width:var(--maxw); margin:0 auto; padding:28px 22px; position:relative; z-index:1}

/* Cards & sections */
.section{background:linear-gradient(180deg,var(--black2),var(--black3)); border:1px solid var(--line); border-radius:var(--r); padding:26px; margin-bottom:24px}
.section h2{margin:0 0 8px; font-size:1.22rem}
.section p{color:var(--mute); margin:4px 0 16px}

/* Tables */
.table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line)}
.table th,.table td{padding:12px 12px; border-bottom:1px solid var(--line); font-size:.95rem}
.table th{background:#0f0f12; color:#fff; text-align:left; letter-spacing:.02em}
.table td{color:#d9d9e2}

/* Code box */
.codebox{border:1px solid var(--line); border-radius:16px; padding:18px; text-align:center; background:linear-gradient(180deg,#0f0f12,#0b0b0c)}
.codebox strong{display:block; color:#fff}
.code{font-size:1.6rem; font-weight:900; color:var(--gold); text-shadow:0 0 12px rgba(182,149,42,.4)}
.code-note{font-size:.86rem; color:var(--mute)}

/* Footer */
footer{border-top:1px solid var(--line); margin-top:20px; background:var(--black4)}
.foot{max-width:var(--maxw); margin:0 auto; padding:20px 22px; color:var(--mute); text-align:center}

/* Modal */
.backdrop{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:60; backdrop-filter:blur(3px)}
.modal{width:min(520px,92vw); background:linear-gradient(180deg,var(--black2),var(--black3)); border:1px solid var(--line); border-radius:18px; padding:20px}
.modal h3{margin:0 0 10px}
.modal .row{display:grid; gap:8px; margin-bottom:12px}
.modal input, .modal textarea{
  width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
  background:#0b0b0c; color:#fff; resize:vertical
}
.modal .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
.badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#151517,#0f0f12); color:#fff; font-size:.88rem}
.note{color:var(--mute); font-size:.9rem}
.error{color:#ff8f8f}
.success{color:#8fffac}

@media (max-width:840px){
  .h-actions{gap:8px}
}
</style>
</head>
<body>
<div class="gridbg" aria-hidden="true"></div>
<div class="noise" aria-hidden="true"></div>

<header>
  <div class="head">
    <div class="brand">
      <img src="logo.png" alt="logo"/>
      <h1>AllergoZyme Passport</h1>
    </div>
    <div class="h-actions">
      <button class="btn" id="sellTipsBtn">Script de vente</button>
      <button class="btn" id="logoutBtn">Déconnexion</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- Passeport santé -->
    <section class="section">
      <div class="badge">Mon passeport santé</div>
      <h2>Ma page Allergie</h2>
      <p>Centralisez vos allergies, intolérances et besoins diabétiques. Accès uniquement sur votre accord, pour créer une preuve lisible et opposable.</p>
      <button class="btn" id="editAllergies">Remplir / Modifier ma page allergie</button>
    </section>

    <!-- Etablissements recommandés -->
    <section class="section">
      <div class="badge">Gains</div>
      <h2>Mes établissements recommandés</h2>
      <p>Chaque établissement inscrit via votre code personnel génère 10 € dès validation (J+14 après adhésion).</p>
      <table class="table">
        <thead><tr><th>Nom</th><th>Date</th><th>Statut</th><th>Gain</th></tr></thead>
        <tbody id="tbody-reco">
          <tr><td colspan="4" style="text-align:center; color:var(--mute)">Chargement…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Restaurants fréquentés (preuve côté client) -->
    <section class="section">
      <div class="badge">Preuve côté client</div>
      <h2>Mes restaurants fréquentés</h2>
      <p class="note">Cette liste vous sert de journal horodaté côté client. Elle s’appuie sur la <strong>même table <code>restaurants</code></strong> (option B) via la colonne <code>client_email</code> (ou équivalents).</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px">
        <button class="btn" id="btnAddVisit">Ajouter une visite</button>
        <span id="visitsHint" class="note"></span>
      </div>
      <table class="table">
        <thead><tr><th>Établissement</th><th>Adresse</th><th>Date</th><th>Source</th></tr></thead>
        <tbody id="tbody-visits">
          <tr><td colspan="4" style="text-align:center; color:var(--mute)">Chargement…</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Code personnel -->
    <section class="section">
      <div class="badge">Parrainage</div>
      <h2>Mon code personnel</h2>
      <div class="codebox">
        <strong>AllergoZyme Passport — Code</strong>
        <div id="userCode" class="code">Chargement…</div>
        <div class="code-note">À communiquer au restaurateur lors de son inscription afin de tracer votre recommandation.</div>
      </div>
    </section>

    <!-- Carte label -->
    <section class="section">
      <div class="badge">Label</div>
      <h2>Carte des établissements labellisés</h2>
      <p>Consultez la carte officielle : <a href="https://www.allergozymelabel.com" target="_blank" style="color:#fff; text-decoration:underline">allergozymelabel.com</a></p>
    </section>

  </div>
</main>

<footer>
  <div class="foot">© <span id="year"></span> AllergoZyme Passport — Données protégées et confidentielles</div>
</footer>

<!-- Modal Ajouter une visite -->
<div class="backdrop" id="modalVisit">
  <div class="modal">
    <h3>Ajouter une visite</h3>
    <div class="row">
      <label for="visitName">Établissement</label>
      <input id="visitName" placeholder="Nom du restaurant" />
    </div>
    <div class="row">
      <label for="visitAddr">Adresse (optionnelle)</label>
      <textarea id="visitAddr" rows="2" placeholder="Adresse complète (si souhaité)"></textarea>
    </div>
    <div class="note">Astuce : la visite sera enregistrée dans <code>restaurants</code> avec <code>client_email = votre email</code>. Vous pouvez ajuster votre schéma plus tard.</div>
    <div id="visitMsg" class="note" style="margin-top:8px"></div>
    <div class="actions">
      <button class="btn" id="visitSave">Enregistrer</button>
      <button class="btn" id="visitCancel">Annuler</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://tmrraeutjrcsozijjbzm.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcnJhZXV0anJjc296aWpqYnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA4NzIsImV4cCI6MjA3NjM3Njg3Mn0.015qUFsUyndsesz5RHGKWO1Ipoz7C3vcVZulACGmq0g'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// DOM
const year = document.getElementById('year'); year.textContent = new Date().getFullYear()
const tbodyReco = document.getElementById('tbody-reco')
const tbodyVisits = document.getElementById('tbody-visits')
const userCodeEl = document.getElementById('userCode')
const visitsHint = document.getElementById('visitsHint')

// header actions
document.getElementById('logoutBtn').onclick = async () => { await sb.auth.signOut(); window.location.href='identification.html' }
document.getElementById('sellTipsBtn').onclick = () => { window.location.href='vendre.html' }
document.getElementById('editAllergies').onclick = () => { window.location.href='remplir-allergies.html' }

// modal
const modal = document.getElementById('modalVisit')
const visitSave = document.getElementById('visitSave')
const visitCancel = document.getElementById('visitCancel')
const visitMsg = document.getElementById('visitMsg')
const visitName = document.getElementById('visitName')
const visitAddr = document.getElementById('visitAddr')
document.getElementById('btnAddVisit').onclick = () => { visitName.value=''; visitAddr.value=''; visitMsg.textContent=''; modal.style.display='flex' }
visitCancel.onclick = () => { modal.style.display='none' }

// auth gate
const { data: { user } } = await sb.auth.getUser()
if(!user){ window.location.href='identification.html' }

// fetch vendeur (code promo)
let codePromo = null
try{
  const { data: vendeur, error: errV } = await sb.from('vendeurs').select('code_promo').eq('email', user.email).single()
  if (errV) throw errV
  codePromo = vendeur?.code_promo || null
  userCodeEl.textContent = codePromo || 'Code non attribué'
}catch(e){
  userCodeEl.textContent = 'Code non attribué'
}

// 1) Recommandés via code parrain
async function loadRecommandes(){
  try{
    if(!codePromo){
      tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucun code personnel trouvé.</td></tr>'
      return
    }
    const { data: etabs, error } = await sb.from('restaurants').select('etablissement, created_at, paiement').eq('code_parrain', codePromo).order('created_at', { ascending:false })
    if(error) throw error
    if(!etabs || etabs.length===0){
      tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucun établissement pour le moment.</td></tr>'
      return
    }
    tbodyReco.innerHTML = etabs.map(e => `
      <tr>
        <td>${e.etablissement ?? '—'}</td>
        <td>${e.created_at ? new Date(e.created_at).toLocaleDateString('fr-FR') : '—'}</td>
        <td>${e.paiement ? 'Validé' : 'En attente'}</td>
        <td>${e.paiement ? '10 €' : '—'}</td>
      </tr>
    `).join('')
  }catch(e){
    tbodyReco.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ff8f8f">Erreur de chargement.</td></tr>'
  }
}

// 2) Visites côté client — OPTION B (dans restaurants)
// on tente plusieurs colonnes usuelles : client_email | email_client | user_email
async function loadVisites(){
  try{
    // essaie client_email
    let all = [], source = null, lastError = null

    const tries = [
      { col:'client_email', label:'client_email' },
      { col:'email_client', label:'email_client' },
      { col:'user_email',   label:'user_email' }
    ]

    for (const t of tries){
      const { data, error } = await sb.from('restaurants').select('etablissement, adresse, created_at').eq(t.col, user.email).order('created_at', { ascending:false })
      if(error){ lastError = error; continue }
      if(data && data.length){
        all = data; source = t.label; break
      }
    }

    // si rien trouvé, affiche message pédagogique
    if(!all.length){
      tbodyVisits.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mute)">Aucune visite enregistrée pour le moment.</td></tr>'
      visitsHint.innerHTML = "Astuce : ajoutez une visite avec le bouton ci-dessus. Si l’enregistrement échoue, créez la colonne <code>client_email</code> (text) dans la table <code>restaurants</code>."
      return
    }

    visitsHint.textContent = source ? ('Source : '+source) : ''
    tbodyVisits.innerHTML = all.map(v => `
      <tr>
        <td>${v.etablissement ?? '—'}</td>
        <td>${v.adresse ?? '—'}</td>
        <td>${v.created_at ? new Date(v.created_at).toLocaleString('fr-FR') : '—'}</td>
        <td>${source || '—'}</td>
      </tr>
    `).join('')

  }catch(e){
    tbodyVisits.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#ff8f8f">Erreur de chargement.</td></tr>'
  }
}

// Insert visite (dans la table restaurants – option B)
visitSave.onclick = async () => {
  visitMsg.className = 'note'
  try{
    const etab = visitName.value.trim()
    const adr = visitAddr.value.trim()
    if(!etab){ visitMsg.className='note error'; visitMsg.textContent='Veuillez renseigner le nom de l’établissement.'; return }

    // on privilégie la colonne client_email
    const payload = {
      etablissement: etab,
      adresse: adr || null,
      client_email: user.email   // ← si la colonne n’existe pas, Supabase renverra une erreur explicite
      // created_at : géré par défaut côté DB si DEFAULT now()
    }

    const { error } = await sb.from('restaurants').insert([payload])
    if(error){
      visitMsg.className='note error'
      visitMsg.innerHTML = 'Erreur : '+error.message+'<br><span class="note">Crée la colonne <code>client_email</code> (type TEXT) dans la table <code>restaurants</code> si elle n’existe pas.</span>'
      return
    }

    visitMsg.className='note success'
    visitMsg.textContent = 'Visite enregistrée.'
    await loadVisites()
    setTimeout(()=>{ modal.style.display='none' }, 800)
  }catch(e){
    visitMsg.className='note error'
    visitMsg.textContent = 'Erreur inconnue.'
  }
}

// init
await loadRecommandes()
await loadVisites()
</script>
</body>
</html>
