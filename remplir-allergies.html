<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AllergoZyme Passport ‚Äî Fiche allerg√®nes</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root {
      --gold:#c9a227;
      --bg:#0b0b0b;
      --line:#222;
      --text:#f1f1f1;
      --maxw:780px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header{
      position:sticky;top:0;z-index:10;
      background:#000c;
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
    }
    .head{
      max-width:var(--maxw);margin:0 auto;
      padding:14px 22px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand img{width:44px;height:44px;}
    .brand h1{
      margin:0;font-size:1rem;font-weight:900;
      text-transform:uppercase;letter-spacing:.1em;
      color:var(--gold);
    }
    .btn{
      padding:10px 16px;border-radius:999px;
      background:linear-gradient(180deg,#1a1a1a,#111);
      border:1px solid var(--line);
      color:#fff;cursor:pointer;
      transition:.2s;
    }
    .btn:hover{box-shadow:0 0 14px rgba(201,162,39,.3)}

    main{flex:1;}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:36px 22px;}
    .card{
      background:#0e0e0e;
      border:1px solid var(--line);
      border-radius:18px;
      padding:28px 24px;
      box-shadow:0 0 40px rgba(0,0,0,.4);
    }
    .title{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
    .title img{width:54px;height:54px;border-radius:10px;}
    h2{margin:0;font-size:1.4rem;color:var(--gold);}
    .desc{color:#aaa;margin:4px 0 18px;font-size:.9rem;}

    form{display:flex;flex-direction:column;gap:20px;}
    .group{
      background:#121212;
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
    }
    .group h3{margin:0 0 12px;color:var(--gold);font-size:1.05rem;}
    input[type=text],input[type=email]{
      width:100%;padding:12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0b0b0b;
      color:#fff;font-size:.95rem;
    }
    input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,162,39,.25);}
    .checkbox-grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:10px 16px;
    }
    label.checkbox{
      display:flex;align-items:center;gap:8px;
      color:#ccc;font-size:.95rem;cursor:pointer;
    }
    input[type=checkbox]{width:18px;height:18px;accent-color:var(--gold);cursor:pointer;}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
    .btn-primary{
      background:linear-gradient(180deg,var(--gold),#9a7d24);
      border:none;color:#fff;
    }
    .btn-secondary{
      background:transparent;border:1px solid var(--line);color:#ddd;
    }
    .btn-primary:hover{box-shadow:0 0 18px rgba(201,162,39,.4)}

    .msg{font-size:.9rem;margin-top:4px;display:none;}
    .msg.success{color:#6cff95;display:block;}
    .msg.error{color:#ff7c7c;display:block;}

    footer{
      border-top:1px solid var(--line);
      background:#0c0c0c;
      text-align:center;
      padding:18px;color:#777;font-size:.9rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand"><img src="logo.png"/><h1>AllergoZyme Passport</h1></div>
      <button class="btn" id="backBtn">Retour</button>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card">
        <div class="title">
          <img src="logo.png"/>
          <div>
            <h2>Ma fiche allerg√®nes</h2>
            <div class="desc">Dossier confidentiel prot√©g√© par AllergoZyme</div>
          </div>
        </div>

        <form id="allergyForm">
          <div class="group">
            <h3>Informations personnelles</h3>
            <input type="text" id="nom" placeholder="Votre nom complet" required>
            <input type="email" id="contact" placeholder="Email" required>
          </div>

          <div class="group">
            <h3>Les 14 allerg√®nes majeurs</h3>
            <div class="checkbox-grid" id="allergenGrid">
              <label class="checkbox"><input type="checkbox" value="Gluten">Gluten</label>
              <label class="checkbox"><input type="checkbox" value="Crustac√©s">Crustac√©s</label>
              <label class="checkbox"><input type="checkbox" value="≈íufs">≈íufs</label>
              <label class="checkbox"><input type="checkbox" value="Poissons">Poissons</label>
              <label class="checkbox"><input type="checkbox" value="Arachides">Arachides</label>
              <label class="checkbox"><input type="checkbox" value="Soja">Soja</label>
              <label class="checkbox"><input type="checkbox" value="Lait">Lait</label>
              <label class="checkbox"><input type="checkbox" value="Fruits √† coque">Fruits √† coque</label>
              <label class="checkbox"><input type="checkbox" value="C√©leri">C√©leri</label>
              <label class="checkbox"><input type="checkbox" value="Moutarde">Moutarde</label>
              <label class="checkbox"><input type="checkbox" value="S√©same">S√©same</label>
              <label class="checkbox"><input type="checkbox" value="Anhydride sulfureux">Anhydride sulfureux / sulfites</label>
              <label class="checkbox"><input type="checkbox" value="Lupin">Lupin</label>
              <label class="checkbox"><input type="checkbox" value="Mollusques">Mollusques</label>
              <label class="checkbox"><input type="checkbox" id="noAllergy" value="NOALL">Je n‚Äôai pas d‚Äôallergie</label>
            </div>
          </div>

          <div class="group">
            <h3>Autres allergies / intol√©rances</h3>
            <input type="text" id="autre" placeholder="Ex : pollen, kiwi, ma√Øs...">
          </div>

          <div class="group">
            <h3>Diab√®te</h3>
            <label class="checkbox"><input type="checkbox" id="diabete">Je suis diab√©tique</label>
          </div>

          <div class="actions">
            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <button type="button" class="btn btn-secondary" id="backBtn2">Retour</button>
          </div>

          <div id="msgSuccess" class="msg success"></div>
          <div id="msgError" class="msg error"></div>
        </form>
      </div>
    </div>
  </main>

  <footer>¬© <span id="year"></span> AllergoZyme Passport ‚Äî Donn√©es prot√©g√©es</footer>

  <!-- ‚úÖ version compatible partout -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.2/dist/umd/supabase.min.js"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://tmrraeutjrcsozijjbzm.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcnJhZXV0anJjc296aWpqYnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA4NzIsImV4cCI6MjA3NjM3Njg3Mn0.015qUFsUyndsesz5RHGKWO1Ipoz7C3vcVZulACGmq0g'
    );

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('year').textContent = new Date().getFullYear();

      const goDash = () => location.href = 'dashboard.html';
      const backBtn=document.getElementById('backBtn'), backBtn2=document.getElementById('backBtn2');
      backBtn && backBtn.addEventListener('click',goDash);
      backBtn2 && backBtn2.addEventListener('click',goDash);

      const form=document.getElementById('allergyForm');
      const msgSuccess=document.getElementById('msgSuccess');
      const msgError=document.getElementById('msgError');
      const nom=document.getElementById('nom');
      const autre=document.getElementById('autre');
      const emailInput=document.getElementById('contact');
      const noAll=document.getElementById('noAllergy');
      const diabete=document.getElementById('diabete');

      // üîπ Auth
      let user=null;
      try{
        const {data,error}=await supabase.auth.getUser();
        if(error)throw error;
        user=data.user;
      }catch(e){console.warn('auth err',e);}
      if(!user){location.href='identification.html';return;}
      emailInput.value=user.email;emailInput.readOnly=true;

      // üîπ Charger fiche existante
      try{
        const {data:fiche}=await supabase.from('passports').select('*').eq('contact',user.email).single();
        if(fiche){
          nom.value=fiche.nom??'';
          autre.value=fiche.autres_allergenes??'';
          diabete.checked=!!fiche.diabete;
          const list=fiche.allergenes?fiche.allergenes.split(',').map(a=>a.trim()):[];
          document.querySelectorAll('#allergenGrid input[type=checkbox]').forEach(cb=>{
            if(list.includes(cb.value))cb.checked=true;
          });
          if(list.length===0){noAll.checked=true;toggleNoAll(true);}
        }
      }catch(e){console.warn(e);}

      // üîπ Logique des cases
      const allergieBoxes=[...document.querySelectorAll('#allergenGrid input[type=checkbox]')].filter(cb=>cb!==noAll);
      function toggleNoAll(active){allergieBoxes.forEach(cb=>{cb.disabled=active;if(active)cb.checked=false;});}
      noAll.addEventListener('change',()=>toggleNoAll(noAll.checked));
      allergieBoxes.forEach(cb=>cb.addEventListener('change',()=>{if(cb.checked){noAll.checked=false;toggleNoAll(false);}}));

      // üîπ Enregistrement
      form.addEventListener('submit',async e=>{
        e.preventDefault();
        msgSuccess.style.display='none';msgError.style.display='none';
        const nomVal=nom.value.trim(), contactVal=user.email, autreVal=autre.value.trim(), diab=diabete.checked;
        let allergenes='';
        if(!noAll.checked){allergenes=allergieBoxes.filter(cb=>cb.checked).map(x=>x.value).join(', ');}
        try{
          const {error}=await supabase.from('passports').upsert([{nom:nomVal,contact:contactVal,allergenes,autres_allergenes:autreVal,diabete:diab}],{onConflict:'contact'});
          if(error)throw error;
          msgSuccess.textContent='Enregistr√© avec succ√®s.';msgSuccess.style.display='block';
        }catch(err){
          console.error('save err',err);
          msgError.textContent='Erreur lors de l‚Äôenregistrement.';msgError.style.display='block';
        }
      });
    });
  </script>
</body>
</html>
